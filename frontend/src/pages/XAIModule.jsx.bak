import { useState, useEffect, useRef, useCallback } from "react";
import { useSearchParams, useNavigate } from "react-router-dom";
import {
  Sparkles,
  Zap,
  ChevronDown,
  ChevronUp,
  Plus,
  Minus,
  RefreshCw,
  Link,
  Image,
  Upload,
  Repeat2,
  Settings2,
  X,
  Dna,
  Trash2,
  Brain,
  Loader2,
  Check,
  Heart,
  Target,
  Wand2,
  Copy,
  TrendingUp,
  MessageSquare,
  Quote,
  FileText,
  Send,
  Mic,
  Smile,
  MoreHorizontal,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { cn } from "@/lib/utils";
import { toast } from "sonner";
import api, { API } from "@/lib/api";
import GenerationCard from "@/components/generation/GenerationCard";
import FloatingQueue from "@/components/generation/FloatingQueue";
import { useProfile } from "@/contexts/ProfileContext";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA: Personas, Tones, Lengths, etc.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const personas = [
  { id: "saf", label: "Saf", desc: "Karakter yok, sadece sen" },
  { id: "otorite", label: "Otorite", desc: "Insider perspective, kesin" },
  { id: "insider", label: "Insider", desc: "Exclusive bilgi vibe" },
  { id: "mentalist", label: "Mentalist", desc: "Teknik + motivasyon" },
  { id: "haber", label: "Haber", desc: "Haber formatÄ±" },
];

const tones = [
  { id: "natural", label: "Natural", desc: "SÄ±fÄ±r yapÄ±, doÄŸal akÄ±ÅŸ" },
  { id: "raw", label: "Raw", desc: "Ham dÃ¼ÅŸÃ¼nce akÄ±ÅŸÄ±" },
  { id: "polished", label: "Polished", desc: "Thesisâ†’Evidenceâ†’Insight" },
  { id: "unhinged", label: "Unhinged", desc: "Shockâ†’Escalateâ†’Twist" },
];

const knowledgeModes = [
  { id: null, label: "Yok", desc: "Ekstra bilgi modu yok" },
  { id: "insider", label: "insider", desc: "Perde arkasÄ± bilgi" },
  { id: "contrarian", label: "contrarian", desc: "Herkesin tersini savun" },
  { id: "hidden", label: "hidden", desc: "Gizli, az bilinen bilgi" },
  { id: "expert", label: "expert", desc: "Derin uzmanlÄ±k bilgisi" },
];

const tweetLengths = [
  { id: "micro", label: "Micro", range: "50-100" },
  { id: "punch", label: "Punch", range: "140-280" },
  { id: "spark", label: "Spark", range: "400-600" },
  { id: "storm", label: "Storm", range: "700-1K" },
  { id: "thread", label: "Thread", range: "3-7 tweet" },
];

const replyLengths = [
  { id: "micro", label: "Micro", range: "50-100" },
  { id: "punch", label: "Punch", range: "140-280" },
  { id: "spark", label: "Spark", range: "400-600" },
];

const articleLengths = [
  { id: "brief", label: "Brief", range: "1.5-2K" },
  { id: "standard", label: "Standard", range: "3-3.5K" },
  { id: "deep", label: "Deep", range: "5K+" },
];

const replyModes = [
  { id: "support", label: "Support", desc: "KatÄ±lÄ±r ve deÄŸer ekler" },
  { id: "challenge", label: "Challenge", desc: "SaygÄ±lÄ±ca karÅŸÄ± gÃ¶rÃ¼ÅŸ sunar" },
  { id: "question", label: "Question", desc: "Merak edilen bir soru sorar" },
  { id: "expand", label: "Expand", desc: "Konuyu yeni bir boyuta taÅŸÄ±r" },
  { id: "joke", label: "Joke", desc: "Esprili ve eÄŸlenceli yanÄ±t verir" },
];

const articleStyles = [
  { id: "raw", label: "Raw", desc: "KiÅŸisel dÃ¼ÅŸÃ¼ncelerini Ã¶zgÃ¼rce paylaÅŸÄ±r" },
  { id: "authority", label: "Authority", desc: "Veri ve Ã¶rneklerle desteklenmiÅŸ yazÄ±" },
  { id: "story", label: "Story", desc: "Bir hikaye gibi anlatan yazÄ±" },
  { id: "tutorial", label: "Tutorial", desc: "AdÄ±m adÄ±m Ã¶ÄŸreten rehber" },
  { id: "opinion", label: "Opinion", desc: "Net bir fikri savunan yazÄ±" },
];

const languages = [
  { id: "auto", label: "Otomatik" },
  { id: "tr", label: "TÃ¼rkÃ§e" },
  { id: "en", label: "English" },
];

// Content type tabs for quick actions
const contentTypes = [
  { id: "tweet", icon: MessageSquare, label: "Tweet" },
  { id: "quote", icon: Quote, label: "AlÄ±ntÄ±" },
  { id: "reply", icon: Repeat2, label: "YanÄ±t" },
  { id: "thread", icon: FileText, label: "Thread" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG Icons (Manus-style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TypeHypeLogo = () => (
  <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
  </svg>
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function SettingsPopup({ open, onClose, settings, onSettingsChange, activeTab }) {
  if (!open) return null;

  const currentLengths = activeTab === "reply" ? replyLengths : 
                         activeTab === "article" ? articleLengths : tweetLengths;

  return (
    <div 
      className="fixed inset-0 z-50"
      onClick={onClose}
    >
      <div 
        className="absolute bottom-24 left-1/2 -translate-x-1/2 w-full max-w-[640px] px-4"
        onClick={(e) => e.stopPropagation()}
      >
        <div
          style={{
            background: "rgba(30,30,30,0.98)",
            border: "1px solid rgba(255,255,255,0.1)",
            borderRadius: "16px",
            padding: "20px",
            backdropFilter: "blur(20px)",
            maxHeight: "60vh",
            overflowY: "auto",
          }}
        >
          <div className="flex items-center justify-between mb-4">
            <span style={{ fontSize: "14px", fontWeight: "600", color: "#fff" }}>
              Ãœretim AyarlarÄ±
            </span>
            <button
              onClick={onClose}
              style={{
                background: "transparent",
                border: "none",
                color: "rgba(255,255,255,0.4)",
                cursor: "pointer",
              }}
            >
              <X size={16} />
            </button>
          </div>

          {/* Mode Toggle */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Mod
            </label>
            <div style={{ display: "flex", gap: "8px" }}>
              {["classic", "apex"].map((m) => (
                <button
                  key={m}
                  onClick={() => onSettingsChange({ ...settings, mode: m })}
                  style={{
                    padding: "6px 16px",
                    borderRadius: "999px",
                    border: settings.mode === m ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: m === "apex" && settings.mode === m
                      ? "linear-gradient(135deg, #eab308, #f97316)"
                      : settings.mode === m
                      ? "rgba(255,255,255,0.9)"
                      : "transparent",
                    color: settings.mode === m ? (m === "apex" ? "#fff" : "#1a1a1a") : "rgba(255,255,255,0.6)",
                    fontSize: "13px",
                    fontWeight: "500",
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    gap: "4px",
                    transition: "all 0.2s ease",
                  }}
                >
                  {m === "apex" && <Zap size={14} />}
                  {m === "classic" ? "Klasik" : "APEX"}
                </button>
              ))}
            </div>
          </div>

          {/* Persona */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Karakter
            </label>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {personas.map((p) => (
                <button
                  key={p.id}
                  onClick={() => onSettingsChange({ ...settings, persona: p.id })}
                  style={{
                    padding: "6px 14px",
                    borderRadius: "999px",
                    border: settings.persona === p.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: settings.persona === p.id ? "rgba(255,255,255,0.9)" : "transparent",
                    color: settings.persona === p.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                    fontSize: "13px",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                >
                  {p.label}
                </button>
              ))}
            </div>
          </div>

          {/* Tone */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Ton
            </label>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {tones.map((t) => (
                <button
                  key={t.id}
                  onClick={() => onSettingsChange({ ...settings, tone: t.id })}
                  style={{
                    padding: "6px 14px",
                    borderRadius: "999px",
                    border: settings.tone === t.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: settings.tone === t.id ? "rgba(255,255,255,0.9)" : "transparent",
                    color: settings.tone === t.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                    fontSize: "13px",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                >
                  {t.label}
                </button>
              ))}
            </div>
          </div>

          {/* Length */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Uzunluk
            </label>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {currentLengths.map((l) => (
                <button
                  key={l.id}
                  onClick={() => onSettingsChange({ ...settings, length: l.id })}
                  style={{
                    padding: "6px 14px",
                    borderRadius: "999px",
                    border: settings.length === l.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: settings.length === l.id ? "rgba(255,255,255,0.9)" : "transparent",
                    color: settings.length === l.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                    fontSize: "12px",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                >
                  {l.label} <span style={{ opacity: 0.5, marginLeft: "4px" }}>{l.range}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Knowledge */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Knowledge Mode
            </label>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {knowledgeModes.map((k) => (
                <button
                  key={k.id || "none"}
                  onClick={() => onSettingsChange({ ...settings, knowledge: k.id })}
                  style={{
                    padding: "6px 14px",
                    borderRadius: "999px",
                    border: settings.knowledge === k.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: settings.knowledge === k.id ? "rgba(255,255,255,0.9)" : "transparent",
                    color: settings.knowledge === k.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                    fontSize: "13px",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                >
                  {k.label}
                </button>
              ))}
            </div>
          </div>

          {/* Language */}
          <div className="mb-4">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Dil
            </label>
            <div style={{ display: "flex", gap: "8px" }}>
              {languages.map((l) => (
                <button
                  key={l.id}
                  onClick={() => onSettingsChange({ ...settings, language: l.id })}
                  style={{
                    padding: "6px 14px",
                    borderRadius: "999px",
                    border: settings.language === l.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                    background: settings.language === l.id ? "rgba(255,255,255,0.9)" : "transparent",
                    color: settings.language === l.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                    fontSize: "13px",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                >
                  {l.label}
                </button>
              ))}
            </div>
          </div>

          {/* Variant Count */}
          <div className="mb-2">
            <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
              Varyant SayÄ±sÄ±
            </label>
            <div style={{ display: "flex", alignItems: "center", gap: "12px" }}>
              <button
                onClick={() => onSettingsChange({ ...settings, variants: Math.max(1, settings.variants - 1) })}
                style={{
                  width: "32px",
                  height: "32px",
                  borderRadius: "50%",
                  border: "1px solid rgba(255,255,255,0.12)",
                  background: "transparent",
                  color: "rgba(255,255,255,0.6)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                }}
              >
                <Minus size={14} />
              </button>
              <span style={{ fontSize: "18px", fontWeight: "600", color: "#fff", width: "24px", textAlign: "center" }}>
                {settings.variants}
              </span>
              <button
                onClick={() => onSettingsChange({ ...settings, variants: Math.min(5, settings.variants + 1) })}
                style={{
                  width: "32px",
                  height: "32px",
                  borderRadius: "50%",
                  border: "1px solid rgba(255,255,255,0.12)",
                  background: "transparent",
                  color: "rgba(255,255,255,0.6)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                }}
              >
                <Plus size={14} />
              </button>
            </div>
          </div>

          {/* Reply-specific: Reply Mode */}
          {activeTab === "reply" && (
            <div className="mb-4 mt-4">
              <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
                Reply Modu
              </label>
              <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
                {replyModes.map((rm) => (
                  <button
                    key={rm.id}
                    onClick={() => onSettingsChange({ ...settings, replyMode: rm.id })}
                    style={{
                      padding: "6px 14px",
                      borderRadius: "999px",
                      border: settings.replyMode === rm.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                      background: settings.replyMode === rm.id ? "rgba(255,255,255,0.9)" : "transparent",
                      color: settings.replyMode === rm.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                      fontSize: "13px",
                      cursor: "pointer",
                      transition: "all 0.2s ease",
                    }}
                  >
                    {rm.label}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Article-specific: Style */}
          {activeTab === "article" && (
            <div className="mb-4 mt-4">
              <label style={{ fontSize: "12px", color: "rgba(255,255,255,0.5)", marginBottom: "8px", display: "block" }}>
                Makale Stili
              </label>
              <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
                {articleStyles.map((as) => (
                  <button
                    key={as.id}
                    onClick={() => onSettingsChange({ ...settings, articleStyle: as.id })}
                    style={{
                      padding: "6px 14px",
                      borderRadius: "999px",
                      border: settings.articleStyle === as.id ? "none" : "1px solid rgba(255,255,255,0.12)",
                      background: settings.articleStyle === as.id ? "rgba(255,255,255,0.9)" : "transparent",
                      color: settings.articleStyle === as.id ? "#1a1a1a" : "rgba(255,255,255,0.6)",
                      fontSize: "13px",
                      cursor: "pointer",
                      transition: "all 0.2s ease",
                    }}
                  >
                    {as.label}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STYLE PROFILE BADGE (compact inline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function StyleProfileBadge() {
  const { profiles, activeProfile, activeProfileId, setActiveProfile, refreshProfiles } = useProfile();
  const [showDropdown, setShowDropdown] = useState(false);
  const navigate = useNavigate();

  if (!profiles || profiles.length === 0) return null;

  return (
    <div style={{ position: "relative" }}>
      <button
        onClick={() => setShowDropdown(!showDropdown)}
        style={{
          display: "flex",
          alignItems: "center",
          gap: "6px",
          padding: "6px 14px",
          borderRadius: "999px",
          border: activeProfile ? "1px solid rgba(168,85,247,0.3)" : "1px solid rgba(255,255,255,0.12)",
          background: activeProfile ? "rgba(168,85,247,0.1)" : "transparent",
          color: activeProfile ? "#c084fc" : "rgba(255,255,255,0.5)",
          fontSize: "13px",
          cursor: "pointer",
          transition: "all 0.2s ease",
          whiteSpace: "nowrap",
        }}
      >
        <Dna size={14} />
        {activeProfile ? activeProfile.name.split(" ")[0] : "Stil"}
        <ChevronDown size={12} style={{ opacity: 0.5 }} />
      </button>

      {showDropdown && (
        <div
          style={{
            position: "absolute",
            bottom: "calc(100% + 8px)",
            left: "0",
            background: "rgba(30,30,30,0.98)",
            border: "1px solid rgba(255,255,255,0.1)",
            borderRadius: "12px",
            padding: "8px",
            minWidth: "220px",
            backdropFilter: "blur(20px)",
            zIndex: 100,
          }}
        >
          {profiles.map((profile) => (
            <button
              key={profile.id}
              onClick={() => { setActiveProfile(profile.id); setShowDropdown(false); }}
              style={{
                width: "100%",
                display: "flex",
                alignItems: "center",
                gap: "10px",
                padding: "8px 12px",
                borderRadius: "8px",
                border: "none",
                background: profile.id === activeProfileId ? "rgba(168,85,247,0.15)" : "transparent",
                color: profile.id === activeProfileId ? "#c084fc" : "rgba(255,255,255,0.7)",
                fontSize: "13px",
                cursor: "pointer",
                transition: "all 0.15s ease",
                textAlign: "left",
              }}
            >
              <div style={{
                width: "24px",
                height: "24px",
                borderRadius: "50%",
                background: "linear-gradient(135deg, #a855f7, #ec4899)",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                flexShrink: 0,
              }}>
                <span style={{ fontSize: "10px", fontWeight: "700", color: "#fff" }}>
                  {profile.name?.charAt(0)?.toUpperCase() || "S"}
                </span>
              </div>
              <span style={{ flex: 1 }}>{profile.name}</span>
              {profile.id === activeProfileId && <Check size={14} />}
            </button>
          ))}

          <div style={{ borderTop: "1px solid rgba(255,255,255,0.08)", margin: "4px 0", paddingTop: "4px" }}>
            <button
              onClick={() => { setActiveProfile(null); setShowDropdown(false); }}
              style={{
                width: "100%",
                display: "flex",
                alignItems: "center",
                gap: "10px",
                padding: "8px 12px",
                borderRadius: "8px",
                border: "none",
                background: "transparent",
                color: "rgba(255,255,255,0.4)",
                fontSize: "13px",
                cursor: "pointer",
              }}
            >
              <X size={14} />
              <span>Stil kapalÄ±</span>
            </button>
            <button
              onClick={() => { navigate("/dashboard/style-lab"); setShowDropdown(false); }}
              style={{
                width: "100%",
                display: "flex",
                alignItems: "center",
                gap: "10px",
                padding: "8px 12px",
                borderRadius: "8px",
                border: "none",
                background: "transparent",
                color: "#a855f7",
                fontSize: "13px",
                cursor: "pointer",
              }}
            >
              <Dna size={14} />
              <span>Style Lab</span>
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ANALYSIS DIALOG (preserved from original)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function AIAnalysisDialog({ open, onOpenChange, profileData }) {
  const [copied, setCopied] = useState(false);
  if (!profileData) return null;
  const fp = profileData.style_fingerprint || {};
  const aiAnalysis = fp.ai_analysis || "";
  const stylePrompt = profileData.style_prompt || "";

  const handleCopyPrompt = () => {
    navigator.clipboard.writeText(stylePrompt);
    setCopied(true);
    toast.success("Stil prompt kopyalandÄ±!");
    setTimeout(() => setCopied(false), 2000);
  };

  const sections = [];
  if (aiAnalysis) {
    const parts = aiAnalysis.split(/\d+\.\s+\*\*/);
    for (const part of parts) {
      if (!part.trim()) continue;
      const titleEnd = part.indexOf("**");
      if (titleEnd > 0) {
        sections.push({
          title: part.substring(0, titleEnd).replace(/\*\*/g, "").trim(),
          content: part.substring(titleEnd + 2).replace(/^\s*:\s*/, "").trim(),
        });
      } else {
        sections.push({ title: "", content: part.trim() });
      }
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Brain className="h-5 w-5 text-purple-400" />
            AI Stil Analizi: {profileData.name}
          </DialogTitle>
          <DialogDescription>
            {fp.tweet_count || 0} tweet analiz edildi
          </DialogDescription>
        </DialogHeader>
        <div className="space-y-6 py-4">
          <div className="grid grid-cols-4 gap-3">
            {[
              { val: fp.tweet_count || 0, label: "Tweet", color: "sky" },
              { val: fp.avg_length || 0, label: "Ort. Karakter", color: "pink" },
              { val: fp.avg_engagement?.likes?.toFixed(0) || 0, label: "Ort. BeÄŸeni", color: "green" },
              { val: fp.emoji_usage?.toFixed(1) || 0, label: "Emoji/Tweet", color: "purple" },
            ].map(({ val, label, color }) => (
              <div key={label} className={`p-3 rounded-xl bg-gradient-to-br from-${color}-500/10 to-${color}-500/10 border border-${color}-500/20 text-center`}>
                <p className={`text-2xl font-bold text-${color}-400`}>{val}</p>
                <p className="text-xs text-muted-foreground">{label}</p>
              </div>
            ))}
          </div>
          {sections.length > 0 && (
            <div className="space-y-3">
              {sections.map((section, idx) => (
                <div key={idx} className="p-4 rounded-xl bg-gradient-to-r from-purple-500/5 to-pink-500/5 border border-purple-500/10">
                  {section.title && <h5 className="font-medium text-purple-300 mb-2">{section.title}</h5>}
                  <p className="text-sm text-muted-foreground whitespace-pre-line leading-relaxed">{section.content}</p>
                </div>
              ))}
            </div>
          )}
          {stylePrompt && (
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <h4 className="font-medium flex items-center gap-2">
                  <Wand2 className="h-4 w-4 text-pink-400" /> Stil Prompt
                </h4>
                <Button variant="ghost" size="sm" onClick={handleCopyPrompt} className="h-8 text-xs">
                  {copied ? <Check className="h-3 w-3 mr-1" /> : <Copy className="h-3 w-3 mr-1" />}
                  {copied ? "KopyalandÄ±" : "Kopyala"}
                </Button>
              </div>
              <div className="p-4 rounded-xl bg-secondary/30 border border-border/50 font-mono text-xs whitespace-pre-wrap max-h-48 overflow-y-auto">
                {stylePrompt}
              </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TWEET PREVIEW CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function TweetPreviewCard({ tweet }) {
  if (!tweet) return null;
  const fmt = (num) => {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num?.toString() || "0";
  };

  return (
    <div style={{
      background: "rgba(255,255,255,0.03)",
      border: "1px solid rgba(255,255,255,0.08)",
      borderRadius: "12px",
      padding: "14px 16px",
      marginBottom: "12px",
    }}>
      <div style={{ display: "flex", alignItems: "start", gap: "10px" }}>
        {tweet.author?.avatar && (
          <img src={tweet.author.avatar.replace("_normal", "_bigger")} alt="" 
            style={{ width: "36px", height: "36px", borderRadius: "50%" }} />
        )}
        <div style={{ flex: 1 }}>
          <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
            <span style={{ fontWeight: "600", fontSize: "13px", color: "#fff" }}>{tweet.author?.name}</span>
            <span style={{ fontSize: "12px", color: "rgba(255,255,255,0.4)" }}>@{tweet.author?.username}</span>
          </div>
          <p style={{ fontSize: "13px", color: "rgba(255,255,255,0.8)", marginTop: "4px", whiteSpace: "pre-wrap", lineHeight: "1.5" }}>
            {tweet.text}
          </p>
          <div style={{ display: "flex", gap: "16px", marginTop: "8px", fontSize: "12px", color: "rgba(255,255,255,0.35)" }}>
            <span>ğŸ’¬ {fmt(tweet.metrics?.replies)}</span>
            <span>ğŸ” {fmt(tweet.metrics?.retweets)}</span>
            <span>â¤ï¸ {fmt(tweet.metrics?.likes)}</span>
          </div>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMO CARDS (Manus-style bottom carousel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const promoCards = [
  {
    title: "Stil Klonlama",
    desc: "BeÄŸendiÄŸin hesabÄ±n yazÄ±m stilini klonla ve o tarzda iÃ§erik Ã¼ret.",
    type: "style",
  },
  {
    title: "APEX Mode",
    desc: "Viral potansiyeli en yÃ¼ksek iÃ§erikler iÃ§in APEX modunu dene.",
    type: "apex",
  },
  {
    title: "Thread GÃ¼cÃ¼",
    desc: "Tek tweet yetmiyorsa, 3-7 tweet'lik thread'ler oluÅŸtur.",
    type: "thread",
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let jobIdCounter = 0;

export default function XAIModule() {
  const [inputValue, setInputValue] = useState("");
  const [activeTab, setActiveTab] = useState("tweet");
  const [isLoaded, setIsLoaded] = useState(false);
  const [activeCard, setActiveCard] = useState(0);
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [tweetUrl, setTweetUrl] = useState("");
  const [tweetData, setTweetData] = useState(null);
  const [fetching, setFetching] = useState(false);
  const [fetched, setFetched] = useState(false);
  const [imageUrl, setImageUrl] = useState(null);
  const [imageBase64, setImageBase64] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [generating, setGenerating] = useState(false);
  const textareaRef = useRef(null);
  const fileInputRef = useRef(null);
  const [searchParams] = useSearchParams();
  const { activeProfileId, activeProfile } = useProfile();

  const [settings, setSettings] = useState({
    mode: "classic",
    persona: "otorite",
    tone: "natural",
    length: "punch",
    knowledge: null,
    language: "auto",
    variants: 3,
    replyMode: "support",
    articleStyle: "authority",
  });

  // Initialize from URL params
  useEffect(() => {
    const topic = searchParams.get("topic") || "";
    const context = searchParams.get("trend_context") || "";
    if (topic) setInputValue(topic);
    if (context) setInputValue((prev) => prev ? `${prev}\n\n${context}` : context);
  }, [searchParams]);

  useEffect(() => {
    setIsLoaded(true);
    const interval = setInterval(() => {
      setActiveCard((prev) => (prev + 1) % promoCards.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const handleTextareaInput = (e) => {
    setInputValue(e.target.value);
    if (textareaRef.current) {
      textareaRef.current.style.height = "auto";
      textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 160) + "px";
    }
  };

  // Fetch tweet for quote/reply
  const handleFetchTweet = async () => {
    const url = inputValue.trim();
    if (!url.match(/x\.com|twitter\.com/)) {
      toast.error("Tweet linki girin");
      return;
    }
    setFetching(true);
    try {
      const response = await api.get(`${API}/tweet/fetch`, { params: { url } });
      if (response.data.success) {
        setTweetData(response.data.tweet);
        setTweetUrl(url);
        setFetched(true);
        toast.success("Tweet Ã§ekildi!");
      } else {
        toast.error("Tweet Ã§ekilemedi");
      }
    } catch (error) {
      toast.error(error.response?.data?.detail || "Tweet Ã§ekilemedi");
    } finally {
      setFetching(false);
    }
  };

  // Image handling
  const handleFileChange = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) { toast.error("Max 5MB"); return; }
      setImageUrl(URL.createObjectURL(file));
      const reader = new FileReader();
      reader.onloadend = () => setImageBase64(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const updateJob = useCallback((jobId, updates) => {
    setJobs((prev) => prev.map((j) => (j.id === jobId ? { ...j, ...updates } : j)));
  }, []);

  const dismissJob = useCallback((jobId) => {
    setJobs((prev) => prev.filter((j) => j.id !== jobId));
  }, []);

  // GENERATE
  const handleGenerate = useCallback(async () => {
    const input = inputValue.trim();
    if (!input && activeTab !== "quote" && activeTab !== "reply") {
      toast.error("Bir ÅŸeyler yaz");
      return;
    }

    // For quote/reply, need fetched tweet
    if ((activeTab === "quote" || activeTab === "reply") && !fetched) {
      // Try to fetch first
      if (input.match(/x\.com|twitter\.com/)) {
        await handleFetchTweet();
        return; // User will click again after fetch
      }
      toast.error("Ã–nce tweet linkini yapÄ±ÅŸtÄ±r");
      return;
    }

    const jobId = `job-${++jobIdCounter}`;
    const type = activeTab === "thread" ? "tweet" : activeTab;
    const newJob = {
      id: jobId,
      type,
      status: "generating",
      startedAt: Date.now(),
      topic: input.slice(0, 60) + (input.length > 60 ? "..." : ""),
      persona: settings.persona,
      personaLabel: personas.find((p) => p.id === settings.persona)?.label,
      toneLabel: tones.find((t) => t.id === settings.tone)?.label,
      lengthLabel: (activeTab === "reply" ? replyLengths : activeTab === "article" ? articleLengths : tweetLengths)
        .find((l) => l.id === settings.length)?.label,
      knowledgeLabel: settings.knowledge ? knowledgeModes.find((k) => k.id === settings.knowledge)?.label : null,
      variantCount: settings.variants,
      variants: null,
    };

    setJobs((prev) => [newJob, ...prev]);
    setGenerating(true);

    try {
      let endpoint, body;

      if (type === "tweet") {
        endpoint = `${API}/generate/tweet`;
        body = {
          topic: input,
          mode: settings.mode,
          length: activeTab === "thread" ? "thread" : settings.length,
          variants: settings.variants,
          persona: settings.persona,
          tone: settings.tone,
          knowledge: settings.knowledge,
          language: settings.language,
          additional_context: null,
          style_profile_id: activeProfileId || null,
          image_url: imageUrl || null,
          image_base64: imageBase64 || null,
        };
      } else if (type === "quote") {
        endpoint = `${API}/generate/quote`;
        body = {
          tweet_url: tweetUrl,
          tweet_content: tweetData?.text || input,
          length: settings.length,
          variants: settings.variants,
          persona: settings.persona,
          tone: settings.tone,
          knowledge: settings.knowledge,
          language: settings.language,
          additional_context: null,
        };
      } else if (type === "reply") {
        endpoint = `${API}/generate/reply`;
        body = {
          tweet_url: tweetUrl,
          tweet_content: tweetData?.text || input,
          length: settings.length,
          reply_mode: settings.replyMode,
          variants: settings.variants,
          persona: settings.persona,
          tone: settings.tone,
          knowledge: settings.knowledge,
          language: settings.language,
          additional_context: null,
        };
      } else if (type === "article") {
        endpoint = `${API}/generate/article`;
        body = {
          topic: input,
          title: null,
          length: settings.length,
          style: settings.articleStyle,
          language: settings.language,
          variants: 1,
          persona: "otorite",
          reference_links: [],
          additional_context: null,
        };
      }

      const response = await api.post(endpoint, body);

      if (response.data.success) {
        updateJob(jobId, {
          status: "completed",
          variants: response.data.variants,
          generationId: response.data.generation_id,
        });
        toast.success("Ä°Ã§erik Ã¼retildi!");
      } else {
        updateJob(jobId, { status: "error" });
        toast.error(response.data.error || "Ãœretim baÅŸarÄ±sÄ±z");
      }
    } catch (error) {
      updateJob(jobId, { status: "error" });
      toast.error(error.response?.data?.detail || "Bir hata oluÅŸtu");
    } finally {
      setGenerating(false);
    }
  }, [inputValue, activeTab, settings, fetched, tweetUrl, tweetData, activeProfileId, imageUrl, imageBase64, updateJob]);

  // Placeholder based on active tab
  const placeholders = {
    tweet: "Tweet konusu yaz veya bir fikir paylaÅŸ...",
    quote: "AlÄ±ntÄ± yapacaÄŸÄ±n tweet linkini yapÄ±ÅŸtÄ±r...",
    reply: "Reply atacaÄŸÄ±n tweet linkini yapÄ±ÅŸtÄ±r...",
    thread: "Thread konusu yaz, detaylÄ± bir fikir paylaÅŸ...",
    article: "Makale konusu yaz...",
  };

  const needsUrl = activeTab === "quote" || activeTab === "reply";
  const isUrlInput = needsUrl && inputValue.match(/x\.com|twitter\.com/);
  const settingsSummary = `${personas.find((p) => p.id === settings.persona)?.label} Â· ${tones.find((t) => t.id === settings.tone)?.label} Â· ${settings.variants}x`;

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "#1a1a1a",
        display: "flex",
        flexDirection: "column",
        alignItems: "center",
        justifyContent: "center",
        fontFamily: "'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif",
        color: "#ffffff",
        padding: "24px 16px",
        position: "relative",
        overflow: "hidden",
      }}
    >
      {/* Subtle background grain */}
      <div
        style={{
          position: "fixed",
          inset: 0,
          background: "radial-gradient(ellipse at 50% 0%, rgba(60,60,70,0.25) 0%, transparent 60%)",
          pointerEvents: "none",
        }}
      />

      {/* Style Profile Badge (top) */}
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: "0",
          background: "rgba(255,255,255,0.06)",
          borderRadius: "999px",
          padding: "6px 4px",
          marginBottom: "32px",
          border: "1px solid rgba(255,255,255,0.08)",
          opacity: isLoaded ? 1 : 0,
          transform: isLoaded ? "translateY(0)" : "translateY(-8px)",
          transition: "all 0.5s ease 0.1s",
        }}
      >
        <StyleProfileBadge />
        <span
          style={{
            width: "1px",
            height: "14px",
            background: "rgba(255,255,255,0.15)",
          }}
        />
        <span
          style={{
            fontSize: "13px",
            color: "rgba(255,255,255,0.4)",
            padding: "4px 14px",
            letterSpacing: "0.01em",
          }}
        >
          {settingsSummary}
        </span>
      </div>

      {/* Main Heading */}
      <h1
        style={{
          fontSize: "clamp(28px, 5vw, 42px)",
          fontWeight: "400",
          fontFamily: "'Georgia', 'Times New Roman', 'Noto Serif', serif",
          textAlign: "center",
          marginBottom: "36px",
          letterSpacing: "-0.01em",
          lineHeight: "1.25",
          fontStyle: "italic",
          opacity: isLoaded ? 1 : 0,
          transform: isLoaded ? "translateY(0)" : "translateY(12px)",
          transition: "all 0.6s ease 0.2s",
        }}
      >
        Ne yazmak istersin?
      </h1>

      {/* Fetched Tweet Preview */}
      {fetched && tweetData && (
        <div style={{ width: "100%", maxWidth: "680px", marginBottom: "12px" }}>
          <TweetPreviewCard tweet={tweetData} />
        </div>
      )}

      {/* Chat Input Container */}
      <div
        style={{
          width: "100%",
          maxWidth: "680px",
          marginBottom: "20px",
          opacity: isLoaded ? 1 : 0,
          transform: isLoaded ? "translateY(0)" : "translateY(12px)",
          transition: "all 0.6s ease 0.3s",
        }}
      >
        <div
          style={{
            background: "rgba(255,255,255,0.05)",
            border: "1px solid rgba(255,255,255,0.1)",
            borderRadius: "16px",
            padding: "16px 18px 12px",
            position: "relative",
          }}
        >
          {/* Image Preview */}
          {imageUrl && (
            <div style={{ marginBottom: "12px", position: "relative", display: "inline-block" }}>
              <img
                src={imageUrl}
                alt=""
                style={{ maxHeight: "80px", borderRadius: "8px" }}
              />
              <button
                onClick={() => { setImageUrl(null); setImageBase64(null); }}
                style={{
                  position: "absolute",
                  top: "-6px",
                  right: "-6px",
                  width: "20px",
                  height: "20px",
                  borderRadius: "50%",
                  background: "#ef4444",
                  border: "none",
                  color: "#fff",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                }}
              >
                <X size={12} />
              </button>
            </div>
          )}

          {/* Textarea */}
          <textarea
            ref={textareaRef}
            value={inputValue}
            onChange={handleTextareaInput}
            placeholder={placeholders[activeTab]}
            rows={2}
            onKeyDown={(e) => {
              if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                handleGenerate();
              }
            }}
            style={{
              width: "100%",
              background: "transparent",
              border: "none",
              outline: "none",
              color: "#ffffff",
              fontSize: "15px",
              lineHeight: "1.55",
              resize: "none",
              fontFamily: "inherit",
              padding: "0",
              marginBottom: "14px",
              caretColor: "#5BA4F5",
            }}
          />

          {/* Toolbar */}
          <div
            style={{
              display: "flex",
              alignItems: "center",
              justifyContent: "space-between",
            }}
          >
            {/* Left Icons */}
            <div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
              {/* Image Upload */}
              <input
                ref={fileInputRef}
                type="file"
                accept="image/jpeg,image/png,image/webp"
                onChange={handleFileChange}
                style={{ display: "none" }}
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                style={{
                  width: "36px",
                  height: "36px",
                  borderRadius: "50%",
                  border: "1px solid rgba(255,255,255,0.12)",
                  background: imageUrl ? "rgba(91,164,245,0.15)" : "transparent",
                  color: imageUrl ? "#5BA4F5" : "rgba(255,255,255,0.45)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                  transition: "all 0.2s ease",
                }}
                title="GÃ¶rsel ekle"
              >
                <Image size={18} />
              </button>

              {/* Link (for fetch tweet) */}
              {needsUrl && (
                <button
                  onClick={handleFetchTweet}
                  disabled={fetching}
                  style={{
                    width: "36px",
                    height: "36px",
                    borderRadius: "50%",
                    border: fetched ? "1px solid rgba(34,197,94,0.3)" : "1px solid rgba(255,255,255,0.12)",
                    background: fetched ? "rgba(34,197,94,0.15)" : "transparent",
                    color: fetched ? "#22c55e" : "rgba(255,255,255,0.45)",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    cursor: "pointer",
                    transition: "all 0.2s ease",
                  }}
                  title="Tweet Ã§ek"
                >
                  {fetching ? <Loader2 size={18} className="animate-spin" /> : <Link size={18} />}
                </button>
              )}

              {/* Settings */}
              <button
                onClick={() => setSettingsOpen(true)}
                style={{
                  width: "36px",
                  height: "36px",
                  borderRadius: "50%",
                  border: "1px solid rgba(255,255,255,0.12)",
                  background: settingsOpen ? "rgba(255,255,255,0.1)" : "transparent",
                  color: "rgba(255,255,255,0.45)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                  transition: "all 0.2s ease",
                }}
                title="Ayarlar"
              >
                <Settings2 size={18} />
              </button>
            </div>

            {/* Right: Send Button */}
            <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
              {/* Send Button */}
              <button
                onClick={handleGenerate}
                disabled={generating}
                style={{
                  width: "36px",
                  height: "36px",
                  borderRadius: "50%",
                  border: "none",
                  background: inputValue.trim() || fetched
                    ? "rgba(255,255,255,0.9)"
                    : "rgba(255,255,255,0.1)",
                  color: inputValue.trim() || fetched
                    ? "#1a1a1a"
                    : "rgba(255,255,255,0.25)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: inputValue.trim() || fetched ? "pointer" : "default",
                  transition: "all 0.25s ease",
                }}
              >
                {generating ? (
                  <Loader2 size={18} className="animate-spin" />
                ) : (
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M12 2L12 22M12 2L5 9M12 2L19 9"
                      stroke="currentColor"
                      strokeWidth="2.5"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      fill="none"
                    />
                  </svg>
                )}
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Quick Action Chips (Content Type Tabs) */}
      <div
        style={{
          display: "flex",
          flexWrap: "wrap",
          gap: "10px",
          justifyContent: "center",
          maxWidth: "680px",
          marginBottom: jobs.length > 0 ? "24px" : "80px",
          opacity: isLoaded ? 1 : 0,
          transform: isLoaded ? "translateY(0)" : "translateY(12px)",
          transition: "all 0.6s ease 0.45s",
        }}
      >
        {contentTypes.map((ct) => {
          const Icon = ct.icon;
          const isActive = activeTab === ct.id;
          return (
            <button
              key={ct.id}
              onClick={() => {
                setActiveTab(ct.id);
                setFetched(false);
                setTweetData(null);
                setTweetUrl("");
                if (ct.id === "thread") {
                  setSettings((s) => ({ ...s, length: "thread" }));
                } else if (ct.id === "reply") {
                  setSettings((s) => ({ ...s, length: "punch" }));
                } else {
                  setSettings((s) => ({ ...s, length: "punch" }));
                }
              }}
              style={{
                display: "flex",
                alignItems: "center",
                gap: "8px",
                padding: "9px 18px",
                borderRadius: "999px",
                border: isActive
                  ? "1px solid rgba(255,255,255,0.3)"
                  : "1px solid rgba(255,255,255,0.12)",
                background: isActive ? "rgba(255,255,255,0.1)" : "transparent",
                color: isActive
                  ? "rgba(255,255,255,0.95)"
                  : "rgba(255,255,255,0.7)",
                fontSize: "13.5px",
                cursor: "pointer",
                transition: "all 0.2s ease",
                fontFamily: "inherit",
                whiteSpace: "nowrap",
                letterSpacing: "0.01em",
                fontWeight: isActive ? "500" : "400",
              }}
            >
              <Icon size={16} style={{ opacity: isActive ? 0.9 : 0.65 }} />
              {ct.label}
            </button>
          );
        })}
        {/* More button for Article */}
        <button
          onClick={() => {
            setActiveTab("article");
            setSettings((s) => ({ ...s, length: "standard" }));
          }}
          style={{
            display: "flex",
            alignItems: "center",
            gap: "8px",
            padding: "9px 18px",
            borderRadius: "999px",
            border: activeTab === "article"
              ? "1px solid rgba(255,255,255,0.3)"
              : "1px solid rgba(255,255,255,0.12)",
            background: activeTab === "article" ? "rgba(255,255,255,0.1)" : "transparent",
            color: activeTab === "article"
              ? "rgba(255,255,255,0.95)"
              : "rgba(255,255,255,0.7)",
            fontSize: "13.5px",
            cursor: "pointer",
            transition: "all 0.2s ease",
            fontFamily: "inherit",
            whiteSpace: "nowrap",
          }}
        >
          <MoreHorizontal size={16} style={{ opacity: 0.65 }} />
          Makale
        </button>
      </div>

      {/* Generation Results */}
      {jobs.length > 0 && (
        <div
          style={{
            width: "100%",
            maxWidth: "680px",
            marginBottom: "80px",
          }}
        >
          <div style={{ display: "flex", flexDirection: "column", gap: "16px" }}>
            {jobs.map((job) => (
              <GenerationCard key={job.id} job={job} />
            ))}
          </div>
        </div>
      )}

      {/* Floating Queue */}
      <FloatingQueue jobs={jobs} onDismiss={dismissJob} />

      {/* Bottom Promo Card */}
      {jobs.length === 0 && (
        <div
          style={{
            position: "fixed",
            bottom: "32px",
            left: "50%",
            transform: `translateX(-50%) ${isLoaded ? "translateY(0)" : "translateY(20px)"}`,
            opacity: isLoaded ? 1 : 0,
            transition: "all 0.6s ease 0.6s",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            gap: "14px",
          }}
        >
          <div
            style={{
              background: "rgba(255,255,255,0.06)",
              border: "1px solid rgba(255,255,255,0.08)",
              borderRadius: "14px",
              padding: "20px 24px",
              display: "flex",
              alignItems: "center",
              gap: "20px",
              maxWidth: "440px",
              width: "max-content",
              cursor: "pointer",
              transition: "all 0.2s ease",
            }}
          >
            <div style={{ flex: 1 }}>
              <div
                style={{
                  fontSize: "15px",
                  fontWeight: "600",
                  marginBottom: "5px",
                  color: "#ffffff",
                }}
              >
                {promoCards[activeCard].title}
              </div>
              <div
                style={{
                  fontSize: "13px",
                  color: "rgba(255,255,255,0.45)",
                  lineHeight: "1.45",
                }}
              >
                {promoCards[activeCard].desc}
              </div>
            </div>
            {/* Mini Preview */}
            <div
              style={{
                width: "90px",
                height: "64px",
                background: "rgba(0,0,0,0.4)",
                borderRadius: "8px",
                border: "1px solid rgba(255,255,255,0.08)",
                display: "flex",
                flexDirection: "column",
                overflow: "hidden",
                flexShrink: 0,
              }}
            >
              <div
                style={{
                  height: "14px",
                  background: "rgba(255,255,255,0.05)",
                  display: "flex",
                  alignItems: "center",
                  gap: "3px",
                  padding: "0 5px",
                }}
              >
                <span style={{ width: "4px", height: "4px", borderRadius: "50%", background: "#FF5F57" }} />
                <span style={{ width: "4px", height: "4px", borderRadius: "50%", background: "#FEBC2E" }} />
                <span style={{ width: "4px", height: "4px", borderRadius: "50%", background: "#28C840" }} />
                <span style={{ marginLeft: "6px", width: "30px", height: "3px", background: "rgba(255,255,255,0.12)", borderRadius: "2px" }} />
              </div>
              <div
                style={{
                  flex: 1,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                <TypeHypeLogo />
              </div>
            </div>
          </div>

          {/* Carousel Dots */}
          <div style={{ display: "flex", gap: "8px", alignItems: "center" }}>
            {promoCards.map((_, i) => (
              <button
                key={i}
                onClick={() => setActiveCard(i)}
                style={{
                  width: i === activeCard ? "8px" : "6px",
                  height: i === activeCard ? "8px" : "6px",
                  borderRadius: "50%",
                  border: "none",
                  background: i === activeCard ? "rgba(255,255,255,0.6)" : "rgba(255,255,255,0.2)",
                  cursor: "pointer",
                  padding: 0,
                  transition: "all 0.3s ease",
                }}
              />
            ))}
          </div>
        </div>
      )}

      {/* Settings Popup */}
      <SettingsPopup
        open={settingsOpen}
        onClose={() => setSettingsOpen(false)}
        settings={settings}
        onSettingsChange={setSettings}
        activeTab={activeTab}
      />

      {/* Global Styles */}
      <style>{`
        * { margin: 0; padding: 0; box-sizing: border-box; }
        ::placeholder { color: rgba(255,255,255,0.3); }
        textarea::-webkit-scrollbar { width: 4px; }
        textarea::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        button:hover { filter: brightness(1.15); }
        @media (max-width: 640px) {
          h1 { font-size: 26px !important; }
        }
        .animate-spin {
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
}
